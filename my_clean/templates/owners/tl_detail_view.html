{% extends 'base.html' %}

{% block content %}

<div class="breadcrumb mb-4">
    <li class="breadcrumb-item pt-1 text-center"><a href="{% url 'owners:tl_task_view' %}">Tasks List</a></li>
    <li class="breadcrumb-item pt-1 text-center">Order Order Detail</li>
</div>

<div class="container p-3 my-3 border pl-5">

    <h5 class="text-center text-light py-2 px-2 bg-dark">{{ order.order.unique_id }} - {{ order.order.process }} - {{ order.order.service }}</h5>
    {% if order.process != "finish" %}
    <div class="row my-5">
        <div class="col-md-6">
            <button id="start" task-id="{{ order.id }}" class="btn btn-block btn-primary">Start</button>
        </div>
        <div class="col-md-6">
            <button id="end" class="btn btn-block btn-primary" disabled>End</button>
        </div>
    </div>
    {% endif %}
    <div class="row mt-5">
        <div class="col-md-6">
            <p>Customer Name:<br><br> {{ order.order.customer.first_name.capitalize }}  {{ order.order.customer.last_name.capitalize }}</p>
        </div>
        <div class="col-md-6">
            <p>City:<br><br> {{ order.order.address.city.city_name.capitalize }}  {{ order.order.address.city.state.state_name.capitalize }}</p>
        </div>
    </div>
    <div class="row mt-5">
        <div class="col-md-6">
            <p>Contact:<br><br> {{ order.order.customer.mobile_no }} <br> {{ order.order.customer.email }}</p>
        </div>
        <div class="col-md-6">
            <p>Address:<br><br> {{ order.order.address.street }} <br> {{ order.order.address.building }}</p>
        </div>
    </div>
    {% for evaluation in order.order.order_pk.all %}
    <div class="row mt-5">
        <div class="col-md-3">
            <p>Booked By Agent:<br><br>  {{ evaluation.evaluator_order_task.created_by.get_full_name }}</p>
        </div>
        <div class="col-md-3">
            <p>Booked Time:<br><br> {{ evaluation.evaluator_order_task.order.date.date }} <br> {{ evaluation.evaluator_order_task.date.time }}</p>
        </div>
        <div class="col-md-3">
            <p>Assigned Evaluator:<br><br>  {{ evaluation.evaluator_order_task.assigned_to.get_full_name }}</p>
        </div>
        <div class="col-md-3">
            <p>Evaluation Time:<br><br> {{ evaluation.evaluator_order_task.schedule_on.date }} <br> {{ evaluation.evaluator_order_task.schedule_on.time }}</p>
        </div>
    </div>
    <div class="row mt-5">
        <div class="col-md-3">
            <p>Dust Level Price:<br><br>  {{ evaluation.dust_level }} - {{ evaluation.dust_level.price }}</p>
        </div>
        <div class="col-md-3">
            <p>Team Members:<br><br> {{ evaluation.team_members }}</p>
        </div>
        {% if evaluation.discount != 0 %}
        <div class="col-md-3">
            <p>Estimated Price:<br><br> {{ evaluation.estimated_price |add:evaluation.discount }}</p>
        </div>
        {% else %}
        <div class="col-md-3">
            <p>Final Estimated Price:<br><br> {{ evaluation.estimated_price }}</p>
        </div>
        {% endif %}
        <div class="col-md-3">
            <p>Evaluation Complete:<br><br> {{ evaluation.evaluation_date.date }} <br> {{ evaluation.evaluation_date.time }}</p>
        </div>
    </div>
{% if evaluation.discount != 0 %}
    <div class="row mt-5">
        <div class="col-md-3">
            <p>Senior Team Leader:<br><br> {{ evaluation.assigned_to.get_full_name }}</p>
        </div>
        <div class="col-md-3">
            <p>Discount:<br><br> {{ evaluation.discount }}</p>
        </div>
        <div class="col-md-3">
            <p>Final Estimated Price:<br><br> {{ evaluation.estimated_price }}</p>
        </div>
        <div class="col-md-3">
            <p>Cleaning Time:<br><br> {{ evaluation.expected_time.date }} <br> {{ evaluation.expected_time.time }}</p>
        </div>
    </div>
    {% else %}
    <div class="row mt-5">
        <div class="col-md-6">
            <p>Senior Team Leader:<br><br> {{ evaluation.assigned_to.get_full_name }}</p>
        </div>
        <div class="col-md-6">
            <p>Cleaning Time:<br><br> {{ evaluation.expected_time.date }} <br> {{ evaluation.expected_time.time }}</p>
        </div>
    </div>
{% endif %}
    {% if order.process == "finish" %}
    <div class="row mt-5">
        <div class="col-md-6">
            <p>
                Cleaning Service Start:
                <br>
                <br>
                {{ evaluation.order.visit_set.first.start.date }}
                <br>
                {{ evaluation.order.visit_set.first.start.time }}
            </p>
        </div>
        <div class="col-md-6">
            <p>
                Cleaning Service End:
                <br>
                <br>
                {{ evaluation.order.visit_set.first.end.date }}
                <br>
                {{ evaluation.order.visit_set.first.end.time }}
            </p>
        </div>
    </div>
    {% endif %}
    <p class="mt-5">Order Description: </p>
    <div class="container p-3 my-3 border pl-5">
        <h6>{{ evaluation.order.description }}</h6>
    </div>
    <p class="mt-5">Evaluation Description: </p>
    <div class="container p-3 my-3 border pl-5">
        <h6>{{ evaluation.description }}</h6>
    </div>
    {% endfor %}
</div>

<!--<div class="col-lg-8 mb-4">-->
<!--    &lt;!&ndash; Embedded Google Map &ndash;&gt;-->
<!--    <iframe width="100%" height="400px" frameborder="0" scrolling="no" marginheight="0" marginwidth="0"-->
<!--            src="http://maps.google.com/maps?hl=en&amp;ie=UTF8&amp;ll=23.022444, 72.509648&amp;spn=56.506174,79.013672&amp;t=m&amp;z=4&amp;output=embed">-->
<!--    </iframe>-->
<!--</div>-->

{% endblock %}

{% block js %}
<script>
    $(document).ready(function(){
         $('#start').click(function(){
            $(this).attr("class", "btn btn-block  btn-outline-danger");
            $(this).prop('disabled', true);
            $('#end').prop('disabled', false);
            var task_id = $(this).attr('task-id');
            var url = '{% url 'owners:tl_start' %}';
            $.ajax({
                url:url,
                data:{
                    task_id:task_id
                },
                success:function(data){
                    $('#end').attr('visit_id', data.visit_id);
                }
            });
         });

         $('#end').click(function(){
            $(this).attr("class", "btn btn-block  btn-outline-danger");
            $(this).prop('disabled', true);
            var visit_id = $(this).attr('visit_id');
            var url = '{% url 'owners:tl_end' %}';
             $.ajax({
                url:url,
                data:{
                    visit_id:visit_id
                },
                success:function(data){
                }
            });
         });
    });
</script>
{% endblock %}